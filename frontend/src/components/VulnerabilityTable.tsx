import React, { useMemo, useState, useEffect } from 'react';
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  getPaginationRowModel,
  getGroupedRowModel,
  flexRender,
  ColumnDef,
  Row,
} from '@tanstack/react-table';
import { ChevronDown, ChevronUp, Edit, Trash2, CheckSquare, Square, AlertCircle } from 'lucide-react';
import ContextMenu from './ContextMenu';
import BulkActionBar from './BulkActionBar';
import { Vulnerability as ApiVulnerability } from '../api';

// Dummy data
const mockData = [
  {
    id: '1',
    language: 'Python',
    file: 'app/models/scan.py',
    line: 42,
    type: 'SQL Injection',
    severity: 'critical',
    status: 'Open',
    description: 'Unsanitized input in SQL query',
  },
  {
    id: '2',
    language: 'Python',
    file: 'app/models/scan.py',
    line: 88,
    type: 'Hardcoded Secret',
    severity: 'high',
    status: 'In Progress',
    description: 'Hardcoded API key',
  },
  {
    id: '3',
    language: 'JavaScript',
    file: 'frontend/src/App.tsx',
    line: 12,
    type: 'XSS',
    severity: 'medium',
    status: 'Open',
    description: 'Unescaped user input in JSX',
  },
  {
    id: '4',
    language: 'C++',
    file: 'test_repo/vuln_sample.cpp',
    line: 7,
    type: 'Buffer Overflow',
    severity: 'critical',
    status: 'Open',
    description: 'Unsafe strcpy usage',
  },
  {
    id: '5',
    language: 'JavaScript',
    file: 'frontend/src/App.tsx',
    line: 30,
    type: 'Insecure Dependency',
    severity: 'low',
    status: 'Resolved',
    description: 'Outdated package',
  },
  {
    id: '6',
    language: 'Python',
    file: 'app/routers/scan.py',
    line: 15,
    type: 'Information Disclosure',
    severity: 'informational',
    status: 'Open',
    description: 'Debug info in response',
  },
];

const severityColors: Record<string, string> = {
  critical: 'bg-status-critical',
  high: 'bg-status-high',
  medium: 'bg-status-medium',
  low: 'bg-status-low',
  informational: 'bg-status-info',
};

const statusColors: Record<string, string> = {
  Open: 'bg-status-critical',
  'In Progress': 'bg-status-high',
  Resolved: 'bg-status-low',
};

function StatusBadge({ severity, children }: { severity: string; children: React.ReactNode }) {
  return (
    <span
      className={`px-2 py-0.5 rounded text-xs font-semibold text-white ${severityColors[severity] || 'bg-gray-400'}`}
    >
      {children}
    </span>
  );
}

function RowActions({ onEdit, onDelete }: { onEdit: () => void; onDelete: () => void }) {
  return (
    <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
      <button onClick={onEdit} className="p-1 hover:bg-primary/10 rounded">
        <Edit className="w-4 h-4 text-primary" />
      </button>
      <button onClick={onDelete} className="p-1 hover:bg-status-critical/10 rounded">
        <Trash2 className="w-4 h-4 text-status-critical" />
      </button>
    </div>
  );
}

export type Vulnerability = typeof mockData[0];

export interface VulnerabilityTableProps {
  vulnerabilities?: ApiVulnerability[];
  loading?: boolean;
  error?: string;
}

const VulnerabilityTable: React.FC<VulnerabilityTableProps> = ({ 
  vulnerabilities = [], 
  loading = false, 
  error 
}) => {
  // Ensure vulnerabilities is always an array and add logging
  const safeVulnerabilities = useMemo(() => {
    console.log('VulnerabilityTable received vulnerabilities:', vulnerabilities);
    
    if (!vulnerabilities) {
      console.log('Vulnerabilities is null/undefined, using empty array');
      return [];
    }
    
    if (!Array.isArray(vulnerabilities)) {
      console.warn('Vulnerabilities is not an array:', typeof vulnerabilities, vulnerabilities);
      return [];
    }
    
    console.log('Vulnerabilities is valid array with', vulnerabilities.length, 'items');
    return vulnerabilities;
  }, [vulnerabilities]);

  // Transform API data to match table format
  const transformedData = useMemo(() => {
    console.log('Transforming vulnerabilities:', safeVulnerabilities);
    
    return safeVulnerabilities.map((vuln, index) => ({
      id: `vuln-${index}`,
      language: vuln.language || 'Unknown',
      file: vuln.file_path,
      line: vuln.line_number,
      type: vuln.type,
      severity: vuln.severity,
      status: 'Open', // Default status
      description: vuln.description,
      code_snippet: vuln.code_snippet,
      recommendation: vuln.recommendation,
    }));
  }, [safeVulnerabilities]);

  const [data, setData] = useState<Vulnerability[]>(transformedData);
  const [rowSelection, setRowSelection] = useState<Record<string, boolean>>({});
  const [sorting, setSorting] = useState<any[]>([]);
  const [pagination, setPagination] = useState({ pageIndex: 0, pageSize: 5 });
  const [contextMenu, setContextMenu] = useState<{ x: number; y: number; row: Row<Vulnerability> | null } | null>(null);

  // Update data when props change
  useEffect(() => {
    setData(transformedData);
  }, [transformedData]);

  const columns = useMemo<ColumnDef<Vulnerability, any>[]>(
    () => [
      {
        id: 'select',
        header: ({ table }) => (
          <button
            onClick={() => {
              const allSelected = table.getIsAllRowsSelected();
              table.toggleAllRowsSelected(!allSelected);
            }}
            className="flex items-center justify-center"
            aria-label="Select all"
          >
            {table.getIsAllRowsSelected() ? <CheckSquare className="w-4 h-4 text-primary" /> : <Square className="w-4 h-4 text-gray-400" />}
          </button>
        ),
        cell: ({ row }) => (
          <button
            onClick={() => row.toggleSelected()}
            className="flex items-center justify-center"
            aria-label="Select row"
          >
            {row.getIsSelected() ? <CheckSquare className="w-4 h-4 text-primary" /> : <Square className="w-4 h-4 text-gray-400" />}
          </button>
        ),
        size: 32,
      },
      {
        accessorKey: 'file',
        header: 'File Name',
        cell: info => <span className="font-mono text-sm">{info.getValue()}</span>,
        enableSorting: true,
      },
      {
        accessorKey: 'line',
        header: 'Line',
        cell: info => <span className="text-xs">{info.getValue()}</span>,
        enableSorting: true,
        size: 60,
      },
      {
        accessorKey: 'type',
        header: 'Vulnerability Type',
        cell: info => <span className="text-sm">{info.getValue()}</span>,
        enableSorting: true,
      },
      {
        accessorKey: 'severity',
        header: 'Severity',
        cell: info => <StatusBadge severity={info.getValue()}>{info.getValue()}</StatusBadge>,
        enableSorting: true,
        size: 100,
      },
      {
        accessorKey: 'status',
        header: 'Status',
        cell: info => <span className={`px-2 py-0.5 rounded text-xs font-semibold text-white ${statusColors[info.getValue()] || 'bg-gray-400'}`}>{info.getValue()}</span>,
        enableSorting: true,
        size: 100,
      },
      {
        id: 'actions',
        header: '',
        cell: ({ row }) => (
          <div className="flex justify-end">
            <RowActions
              onEdit={() => alert(`Edit ${row.original.id}`)}
              onDelete={() => setData(d => d.filter(v => v.id !== row.original.id))}
            />
          </div>
        ),
        size: 60,
      },
    ],
    [setData]
  );

  const table = useReactTable({
    data,
    columns,
    state: {
      rowSelection,
      sorting,
      pagination,
    },
    onRowSelectionChange: setRowSelection,
    onSortingChange: setSorting,
    onPaginationChange: setPagination,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getGroupedRowModel: getGroupedRowModel(),
    enableRowSelection: true,
    getRowId: row => row.id,
    debugTable: false,
  });

  // Group by language and file
  const grouped = useMemo(() => {
    const groups: Record<string, Record<string, Vulnerability[]>> = {};
    data.forEach(vuln => {
      if (!groups[vuln.language]) groups[vuln.language] = {};
      if (!groups[vuln.language][vuln.file]) groups[vuln.language][vuln.file] = [];
      groups[vuln.language][vuln.file].push(vuln);
    });
    return groups;
  }, [data]);

  // Helper: get selected vulnerabilities
  const selectedIds = Object.keys(rowSelection).filter(id => rowSelection[id]);
  const selectedVulns = data.filter(v => selectedIds.includes(v.id));

  // Bulk actions
  const handleBulkDelete = () => {
    setData(d => d.filter(v => !selectedIds.includes(v.id)));
    setRowSelection({});
  };
  const handleBulkStatus = (status: string) => {
    setData(d => d.map(v => selectedIds.includes(v.id) ? { ...v, severity: status } : v));
    setRowSelection({});
  };
  const handleBulkExport = () => {
    const json = JSON.stringify(selectedVulns, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'vulnerabilities.json';
    a.click();
    URL.revokeObjectURL(url);
  };

  // Context menu handler
  const handleContextMenu = (e: React.MouseEvent, row: Row<Vulnerability>) => {
    e.preventDefault();
    setContextMenu({ x: e.clientX, y: e.clientY, row });
  };

  // Loading state
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[300px] text-textSecondary animate-pulse">
        <div className="text-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
          <p>Scanning repository...</p>
        </div>
      </div>
    );
  }

  // Error state
  if (error) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[300px] text-textSecondary">
        <AlertCircle className="w-12 h-12 text-status-critical mb-4" />
        <span className="text-lg font-semibold mb-2">Scan Failed</span>
        <span className="text-sm text-center max-w-md">{error}</span>
      </div>
    );
  }

  // Empty state
  if (!data.length) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[300px] text-textSecondary">
        <span className="text-lg font-semibold mb-2">No vulnerabilities found</span>
        <span className="text-sm">Try scanning a repository to see results.</span>
      </div>
    );
  }

  return (
    <div className="bg-card rounded shadow p-0 overflow-x-auto">
      {/* Bulk Action Bar */}
      {selectedIds.length > 0 && (
        <BulkActionBar
          selectedCount={selectedIds.length}
          onDelete={handleBulkDelete}
          onExport={handleBulkExport}
          onChangeStatus={handleBulkStatus}
        />
      )}
      {/* Table */}
      <table className="min-w-full divide-y divide-gray-200">
        <thead className="bg-background">
          {table.getHeaderGroups().map(headerGroup => (
            <tr key={headerGroup.id}>
              {headerGroup.headers.map(header => (
                <th
                  key={header.id}
                  colSpan={header.colSpan}
                  className={`px-3 py-2 text-left text-xs font-semibold text-textSecondary select-none whitespace-nowrap ${header.column.getCanSort() ? 'cursor-pointer group' : ''}`}
                  onClick={header.column.getToggleSortingHandler()}
                >
                  <div className="flex items-center gap-1">
                    {flexRender(header.column.columnDef.header, header.getContext())}
                    {header.column.getCanSort() && (
                      <span className="ml-1">
                        {header.column.getIsSorted() === 'asc' && <ChevronUp className="w-3 h-3 inline" />}
                        {header.column.getIsSorted() === 'desc' && <ChevronDown className="w-3 h-3 inline" />}
                      </span>
                    )}
                  </div>
                </th>
              ))}
            </tr>
          ))}
        </thead>
        <tbody className="divide-y divide-gray-100">
          {/* Grouped by language */}
          {Object.entries(grouped).map(([language, files]) => (
            <React.Fragment key={language}>
              <tr>
                <td colSpan={columns.length} className="bg-gray-100 px-3 py-2 font-bold text-primary text-sm">
                  {language}
                </td>
              </tr>
              {Object.entries(files).map(([file, vulns]) => (
                <React.Fragment key={file}>
                  <tr>
                    <td colSpan={columns.length} className="bg-gray-50 px-3 py-1 font-mono text-xs text-textSecondary">
                      {file}
                    </td>
                  </tr>
                  {vulns.map(vuln => {
                    const row = table.getRowModel().rows.find(r => r.original.id === vuln.id);
                    if (!row) return null;
                    return (
                      <tr
                        key={vuln.id}
                        className="group hover:bg-primary/5 transition cursor-pointer relative"
                        onContextMenu={e => handleContextMenu(e, row)}
                      >
                        {row.getVisibleCells().map(cell => (
                          <td
                            key={cell.id}
                            className={`px-3 py-2 whitespace-nowrap ${cell.column.id === 'select' ? 'w-8' : ''}`}
                          >
                            {flexRender(cell.column.columnDef.cell, cell.getContext())}
                          </td>
                        ))}
                        {/* Actions on hover for the row */}
                        <td className="absolute right-2 top-1/2 -translate-y-1/2">
                          <div className="hidden group-hover:flex gap-2">
                            <button
                              onClick={() => alert(`Edit ${vuln.id}`)}
                              className="p-1 hover:bg-primary/10 rounded"
                            >
                              <Edit className="w-4 h-4 text-primary" />
                            </button>
                            <button
                              onClick={() => setData(d => d.filter(v => v.id !== vuln.id))}
                              className="p-1 hover:bg-status-critical/10 rounded"
                            >
                              <Trash2 className="w-4 h-4 text-status-critical" />
                            </button>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </React.Fragment>
              ))}
            </React.Fragment>
          ))}
        </tbody>
      </table>
      {/* Pagination */}
      <div className="flex items-center justify-between px-4 py-2 border-t border-gray-100 bg-background text-xs">
        <div>
          Page {table.getState().pagination.pageIndex + 1} of {table.getPageCount()}
        </div>
        <div className="flex gap-2">
          <button
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
            className="px-2 py-1 rounded border border-gray-200 bg-white hover:bg-gray-50 disabled:opacity-50"
          >
            Previous
          </button>
          <button
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
            className="px-2 py-1 rounded border border-gray-200 bg-white hover:bg-gray-50 disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>
      {/* Context Menu */}
      {contextMenu && contextMenu.row && (
        <ContextMenu
          x={contextMenu.x}
          y={contextMenu.y}
          onClose={() => setContextMenu(null)}
          onAction={action => {
            setContextMenu(null);
            if (typeof action === 'string') {
              if (action === 'delete') {
                setData(d => d.filter(v => v.id !== contextMenu.row!.original.id));
              } else {
                alert(`Action: ${action} on ${contextMenu.row!.original.id}`);
              }
            } else if ('tag' in action) {
              alert(`Tag: ${action.tag} on ${contextMenu.row!.original.id}`);
            } else if ('status' in action) {
              setData(d => d.map(v => v.id === contextMenu.row!.original.id ? { ...v, severity: action.status } : v));
            }
          }}
        />
      )}
    </div>
  );
};

export default VulnerabilityTable; 